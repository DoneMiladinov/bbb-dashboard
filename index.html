<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaign Insights - Branding By Books</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{font-family:'Open Sans',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(145deg,#13002d 0%,#1a0442 50%,#0f0025 100%);min-height:100vh;padding:80px 30px 50px;color:#fff;position:relative}
    body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 20% 20%,rgba(139,92,246,.08) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(167,139,250,.06) 0%,transparent 50%);pointer-events:none;z-index:0}
    .nav-bar{position:fixed;top:0;left:0;right:0;background:rgba(19,0,45,.95);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08);z-index:1000;padding:0 30px}
    .nav-container{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:60px}
    .nav-logo{height:22px;opacity:.9}
    .nav-links{display:flex;gap:8px}
    .nav-link{color:rgba(255,255,255,.6);text-decoration:none;font-size:11px;font-weight:500;padding:8px 12px;border-radius:8px;transition:all .3s;text-transform:uppercase;letter-spacing:.6px}
    .nav-link:hover{color:rgba(255,255,255,.95);background:rgba(139,92,246,.2)}
    .nav-link.active{color:#a78bfa;background:rgba(139,92,246,.15)}
    .container{max-width:980px;margin:0 auto;position:relative;z-index:1}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-top:20px}
    .header-left{display:flex;align-items:center;gap:16px}
    .logo-stack{height:28px}
    .header-divider{width:1px;height:20px;background:rgba(255,255,255,.15)}
    .client-name{font-size:18px;font-weight:600;color:rgba(255,255,255,.85);letter-spacing:-.01em}
    .header-right{text-align:right}
    .report-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.4);margin-bottom:4px;font-weight:600}
    .date-range{font-size:14px;color:rgba(255,255,255,.65);font-weight:400}
    .month-selector{display:flex;gap:8px;margin-bottom:50px;flex-wrap:wrap}
    .month-btn{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);padding:8px 18px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;transition:all .3s;font-family:inherit;letter-spacing:.3px}
    .month-btn:hover{background:rgba(139,92,246,.15);border-color:rgba(167,139,250,.3);color:rgba(255,255,255,.9)}
    .month-btn.active{background:linear-gradient(135deg,rgba(139,92,246,.3),rgba(167,139,250,.2));border-color:rgba(167,139,250,.4);color:#fff;box-shadow:0 0 20px rgba(139,92,246,.15)}
    .section{padding-top:30px;margin-bottom:60px;scroll-margin-top:80px}
    .section-title{margin:0 0 24px;font-size:14px;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.5);font-weight:600;display:flex;align-items:center;gap:12px}
    .section-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(255,255,255,.1),transparent)}
    .metrics-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:20px}
    .metric-card{background:linear-gradient(165deg,rgba(255,255,255,.06) 0%,rgba(255,255,255,.02) 100%);border:1px solid rgba(255,255,255,.08);border-radius:24px;padding:28px 22px;text-align:center;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:140px}
    .metric-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent)}
    .metric-card.highlight{background:linear-gradient(165deg,rgba(139,92,246,.16) 0%,rgba(167,139,250,.06) 100%);border-color:rgba(167,139,250,.2)}
    .metric-value{font-size:36px;font-weight:700;color:#fff;margin-bottom:8px;line-height:1;letter-spacing:-.02em}
    .metric-label{font-size:11px;color:rgba(255,255,255,.5);font-weight:600;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:6px}
    .metric-subtext{font-size:13px;color:rgba(167,139,250,.7);font-weight:400}
    .metric-subtext.good{color:#4ade80}
    .charts-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .chart-container{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:24px}
    .chart-title{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.4);margin-bottom:20px;font-weight:600}
    .bar-chart{display:flex;flex-direction:column;gap:12px}
    .bar-row{display:grid;grid-template-columns:80px 1fr 50px;align-items:center;gap:12px}
    .bar-label{font-size:12px;color:rgba(255,255,255,.8);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bar-track{height:20px;background:rgba(255,255,255,.05);border-radius:5px;overflow:hidden}
    .bar-fill{height:100%;border-radius:5px;transition:width .6s}
    .bar-fill.positive{background:linear-gradient(90deg,#22c55e,#4ade80)}
    .bar-fill.booked{background:linear-gradient(90deg,#8b5cf6,#a78bfa)}
    .bar-value{font-size:12px;color:rgba(255,255,255,.7);text-align:right;font-weight:600}
    .table-wrap{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:16px;overflow:hidden}
    .table-scroll{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:13px;min-width:700px}
    thead tr{background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.06)}
    th,td{text-align:left;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
    th{color:rgba(255,255,255,.4);font-weight:500;text-transform:uppercase;letter-spacing:.8px;font-size:10px;cursor:pointer;user-select:none;transition:color .2s;white-space:nowrap}
    th:hover{color:rgba(255,255,255,.7)}
    th .sort-icon{display:inline-block;margin-left:4px;opacity:.4;font-size:8px}
    th.sort-asc .sort-icon{opacity:1}
    th.sort-desc .sort-icon{opacity:1}
    td{color:rgba(255,255,255,.8)}
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover{background:rgba(255,255,255,.02)}
    tfoot tr{background:rgba(255,255,255,.04)}
    tfoot td{font-weight:600;color:rgba(255,255,255,.9);border-bottom:none}
    .numeric{text-align:right}
    .badge{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:500;display:inline-block}
    .badge-strong{background:rgba(34,197,94,.2);color:#4ade80}
    .badge-average{background:rgba(59,130,246,.2);color:#60a5fa}
    .badge-weak{background:rgba(234,179,8,.2);color:#facc15}
    .recommendations-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
    .recommendation-card{background:linear-gradient(165deg,rgba(255,255,255,.05) 0%,rgba(255,255,255,.02) 100%);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px}
    .recommendation-card h3{font-size:14px;font-weight:600;color:rgba(255,255,255,.9);margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .recommendation-card h3 .type-icon{width:8px;height:8px;border-radius:50%;background:#a78bfa}
    .strategy-rank{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .strategy-rank:last-child{border-bottom:none}
    .rank-number{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
    .rank-1{background:rgba(250,204,21,.2);color:#facc15}
    .rank-2{background:rgba(148,163,184,.2);color:#94a3b8}
    .rank-3{background:rgba(180,83,9,.2);color:#d97706}
    .strategy-name{font-size:14px;font-weight:600;color:rgba(255,255,255,.9)}
    .strategy-metrics{margin-left:auto;display:flex;gap:16px;font-size:11px}
    .strategy-metric{text-align:right}
    .strategy-metric-value{font-weight:600;color:#4ade80}
    .strategy-metric-label{color:rgba(255,255,255,.4);text-transform:uppercase;font-size:9px;letter-spacing:.5px}
    .footer{margin-top:50px;padding-top:24px;border-top:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center}
    .footer-text{font-size:11px;color:rgba(255,255,255,.3);letter-spacing:.5px;font-weight:400}
    .footer-logo{height:20px;opacity:.3}
    @media(max-width:800px){
      body{padding:80px 20px 30px}
      .metrics-grid{grid-template-columns:1fr}
      .charts-row{grid-template-columns:1fr}
      .recommendations-grid{grid-template-columns:1fr}
      .metric-value{font-size:32px}
      .header{flex-direction:column;gap:20px}
      .header-right{text-align:center}
      .nav-links{display:none}
      .strategy-metrics{flex-direction:column;gap:4px}
      .month-selector{justify-content:center}
    }
  </style>
</head>
<body>
  <nav class="nav-bar">
    <div class="nav-container">
      <img src="https://cdn.prod.website-files.com/67a3b299626c1a7afb14beb6/67a4b0de8c572bff612d91d1_stack-optimize-logo.avif" alt="StackOptimise" class="nav-logo">
      <div class="nav-links">
        <a href="#overview" class="nav-link active">Overview</a>
        <a href="#company-size" class="nav-link">Company Size</a>
        <a href="#company-type" class="nav-link">Company Type</a>
        <a href="#strategy" class="nav-link">Strategy</a>
        <a href="#recommendations" class="nav-link">Recommendations</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <header class="header">
      <div class="header-left">
        <img src="https://cdn.prod.website-files.com/67a3b299626c1a7afb14beb6/67a4b0de8c572bff612d91d1_stack-optimize-logo.avif" alt="StackOptimise" class="logo-stack">
        <div class="header-divider"></div>
        <span class="client-name">Branding By Books</span>
      </div>
      <div class="header-right">
        <div class="report-label" id="report-label">Lifetime Campaign Insights</div>
        <div class="date-range" id="date-range"></div>
      </div>
    </header>

    <div id="month-selector" class="month-selector"></div>

    <section id="overview" class="section">
      <h2 class="section-title">Overview - Top Metrics</h2>
      <div id="overview-content"></div>
    </section>

    <section id="company-size" class="section">
      <h2 class="section-title">Company Size Segmentation</h2>
      <div id="company-size-content"></div>
    </section>

    <section id="company-type" class="section">
      <h2 class="section-title">Company Type Segmentation</h2>
      <div id="company-type-content"></div>
    </section>

    <section id="strategy" class="section">
      <h2 class="section-title">Strategy Segmentation</h2>
      <div id="strategy-content"></div>
    </section>

    <section id="recommendations" class="section">
      <h2 class="section-title">Top Strategies per Company Type</h2>
      <div id="recommendations-content"></div>
    </section>

    <footer class="footer">
      <span class="footer-text">Generated by StackOptimise<span id="last-updated"></span></span>
      <img src="https://cdn.prod.website-files.com/67a3b299626c1a7afb14beb6/67a4b0de8c572bff612d91d1_stack-optimize-logo.avif" alt="StackOptimise" class="footer-logo">
    </footer>
  </div>

  <script>
    // ── DATA (loaded from data.json) ──────────────────────────────────────
    let DATA = { months: {} };

    // ── HELPERS ───────────────────────────────────────────────────────────
    let currentMonth = null;

    function fmt(n) { return n.toLocaleString("en-US"); }
    function pct(num, den) { return den === 0 ? "0.00%" : (num / den * 100).toFixed(2) + "%"; }
    function pctNum(num, den) { return den === 0 ? 0 : num / den * 100; }

    function badgeClass(value, allValues) {
      const sorted = [...allValues].sort((a, b) => b - a);
      const third = Math.ceil(sorted.length / 3);
      const rank = sorted.indexOf(value);
      if (rank < third) return "badge-strong";
      if (rank < third * 2) return "badge-average";
      return "badge-weak";
    }

    // ── LIFETIME AGGREGATION ─────────────────────────────────────────────
    function computeLifetime() {
      const keys = Object.keys(DATA.months);
      if (keys.length === 0) return null;
      if (keys.length === 1) {
        const m = DATA.months[keys[0]];
        return {
          label: "Lifetime",
          dateRange: m.dateRange,
          overview: { ...m.overview },
          companySize: m.companySize.map(r => ({ ...r })),
          companyType: m.companyType.map(r => ({ ...r })),
          strategy: m.strategy.map(r => ({ ...r })),
          recommendations: computeLifetimeRecommendations()
        };
      }

      const result = {
        label: "Lifetime",
        dateRange: "",
        overview: { leads: 0, replies: 0, positives: 0, booked: 0, emailsSent: 0 },
        companySize: [],
        companyType: [],
        strategy: [],
        recommendations: {}
      };

      // Date range: earliest start to latest end
      const allDates = keys.sort();
      const first = DATA.months[allDates[0]];
      const last = DATA.months[allDates[allDates.length - 1]];
      const startDate = first.dateRange.split(" - ")[0];
      const endDate = last.dateRange.split(" - ")[1];
      result.dateRange = startDate + " - " + endDate;

      // Sum overview
      keys.forEach(k => {
        const m = DATA.months[k];
        result.overview.leads += m.overview.leads;
        result.overview.replies += m.overview.replies;
        result.overview.positives += m.overview.positives;
        result.overview.booked += m.overview.booked;
        result.overview.emailsSent += (m.overview.emailsSent || 0);
      });

      // Sum segments by name
      function sumSegment(segKey) {
        const map = {};
        keys.forEach(k => {
          DATA.months[k][segKey].forEach(row => {
            if (!map[row.name]) map[row.name] = { name: row.name, leads: 0, replies: 0, positives: 0, booked: 0 };
            map[row.name].leads += row.leads;
            map[row.name].replies += row.replies;
            map[row.name].positives += row.positives;
            map[row.name].booked += row.booked;
          });
        });
        return Object.values(map);
      }

      result.companySize = sumSegment("companySize");
      result.companyType = sumSegment("companyType");
      result.strategy = sumSegment("strategy");
      result.recommendations = computeLifetimeRecommendations();

      return result;
    }

    function computeLifetimeRecommendations() {
      const keys = Object.keys(DATA.months);
      // Collect all (companyType, strategy) pairs across months
      const map = {}; // map[companyType][strategy] = {leads, positives, booked}
      keys.forEach(k => {
        const recs = DATA.months[k].recommendations;
        Object.keys(recs).forEach(ct => {
          if (!map[ct]) map[ct] = {};
          recs[ct].forEach(r => {
            if (!map[ct][r.strategy]) map[ct][r.strategy] = { strategy: r.strategy, leads: 0, positives: 0, booked: 0 };
            map[ct][r.strategy].leads += r.leads;
            map[ct][r.strategy].positives += r.positives;
            map[ct][r.strategy].booked += r.booked;
          });
        });
      });

      // For each company type, rank by positive rate (positives/leads), take top 3
      const result = {};
      Object.keys(map).forEach(ct => {
        const entries = Object.values(map[ct]);
        entries.sort((a, b) => pctNum(b.positives, b.leads) - pctNum(a.positives, a.leads));
        result[ct] = entries.slice(0, 3);
      });
      return result;
    }

    // ── GET CURRENT DATA ─────────────────────────────────────────────────
    function getCurrentData() {
      if (currentMonth === "lifetime") return computeLifetime();
      return DATA.months[currentMonth];
    }

    // ── RENDER: MONTH SELECTOR ───────────────────────────────────────────
    function renderMonthSelector() {
      const el = document.getElementById("month-selector");
      const keys = Object.keys(DATA.months);
      let html = '<button class="month-btn' + (currentMonth === "lifetime" ? " active" : "") + '" data-month="lifetime">Lifetime</button>';
      keys.forEach(k => {
        const m = DATA.months[k];
        html += '<button class="month-btn' + (currentMonth === k ? " active" : "") + '" data-month="' + k + '">' + m.label + '</button>';
      });
      el.innerHTML = html;
      el.querySelectorAll(".month-btn").forEach(btn => {
        btn.addEventListener("click", () => switchMonth(btn.dataset.month));
      });
    }

    // ── RENDER: OVERVIEW ─────────────────────────────────────────────────
    function renderOverview(data) {
      const o = data.overview;
      const replyRate = pct(o.replies, o.leads);
      const positiveRate = pct(o.positives, o.replies);
      const leadsPerPositive = o.positives === 0 ? "—" : Math.round(o.leads / o.positives);
      const leadsPerCall = o.booked === 0 ? "—" : "1:" + fmt(Math.round(o.leads / o.booked));

      document.getElementById("overview-content").innerHTML =
        '<div class="metrics-grid">' +
          '<div class="metric-card"><div class="metric-value">' + fmt(o.leads) + '</div><div class="metric-label">LEADS CONTACTED</div><div class="metric-subtext good">' + fmt(o.emailsSent || 0) + ' emails sent</div></div>' +
          '<div class="metric-card"><div class="metric-value">' + fmt(o.replies) + '</div><div class="metric-label">REPLIES</div><div class="metric-subtext good">' + replyRate + ' reply rate</div></div>' +
          '<div class="metric-card"><div class="metric-value">' + fmt(o.positives) + '</div><div class="metric-label">POSITIVE REPLIES</div><div class="metric-subtext good">' + positiveRate + ' positive rate</div></div>' +
        '</div>' +
        '<div class="metrics-grid">' +
          '<div class="metric-card"><div class="metric-value">' + leadsPerPositive + '</div><div class="metric-label">LEADS / POSITIVE</div><div class="metric-subtext good">efficiency ratio</div></div>' +
          '<div class="metric-card highlight"><div class="metric-value">' + replyRate + '</div><div class="metric-label">OVERALL REPLY RATE</div><div class="metric-subtext good">reply / leads</div></div>' +
          '<div class="metric-card"><div class="metric-value">' + fmt(o.booked) + '</div><div class="metric-label">BOOKED CALLS</div><div class="metric-subtext good">' + leadsPerCall + ' leads per call</div></div>' +
        '</div>';
    }

    // ── RENDER: SEGMENT (SIZE / TYPE / STRATEGY) ─────────────────────────
    function renderSegment(containerId, rows, labelHeader, posLabel, bookedLabel) {
      if (!rows || rows.length === 0) {
        document.getElementById(containerId).innerHTML =
          '<div class="chart-container" style="text-align:center;padding:40px 24px">' +
          '<div style="color:rgba(255,255,255,.3);font-size:13px;font-weight:500;text-transform:uppercase;letter-spacing:1px">Data coming soon</div>' +
          '</div>';
        return;
      }
      // Sort by positive rate desc for charts
      const byPosRate = [...rows].sort((a, b) => pctNum(b.positives, b.leads) - pctNum(a.positives, a.leads));
      const byBookRate = [...rows].sort((a, b) => pctNum(b.booked, b.leads) - pctNum(a.booked, a.leads));
      const maxPosRate = byPosRate.length ? pctNum(byPosRate[0].positives, byPosRate[0].leads) : 1;
      const maxBookRate = byBookRate.length ? pctNum(byBookRate[0].booked, byBookRate[0].leads) : 1;

      // Badge values for percentile coloring
      const replyRates = rows.map(r => pctNum(r.replies, r.leads));
      const posRates = rows.map(r => pctNum(r.positives, r.leads));
      const bookRates = rows.map(r => pctNum(r.booked, r.leads));

      // Totals
      const totals = rows.reduce((t, r) => ({
        leads: t.leads + r.leads, replies: t.replies + r.replies,
        positives: t.positives + r.positives, booked: t.booked + r.booked
      }), { leads: 0, replies: 0, positives: 0, booked: 0 });

      // Charts
      let posChart = '';
      byPosRate.forEach(r => {
        const rate = pctNum(r.positives, r.leads);
        const w = maxPosRate > 0 ? Math.round(rate / maxPosRate * 100) : 0;
        posChart += '<div class="bar-row"><div class="bar-label">' + r.name + '</div><div class="bar-track"><div class="bar-fill positive" style="width:' + w + '%"></div></div><div class="bar-value">' + pct(r.positives, r.leads) + '</div></div>';
      });

      let bookChart = '';
      byBookRate.forEach(r => {
        const rate = pctNum(r.booked, r.leads);
        const w = maxBookRate > 0 ? Math.round(rate / maxBookRate * 100) : 0;
        bookChart += '<div class="bar-row"><div class="bar-label">' + r.name + '</div><div class="bar-track"><div class="bar-fill booked" style="width:' + w + '%"></div></div><div class="bar-value">' + pct(r.booked, r.leads) + '</div></div>';
      });

      // Table rows
      let tbody = '';
      rows.forEach(r => {
        const rr = pctNum(r.replies, r.leads);
        const pr = pctNum(r.positives, r.leads);
        const br = pctNum(r.booked, r.leads);
        tbody += '<tr>' +
          '<td>' + r.name + '</td>' +
          '<td class="numeric">' + fmt(r.leads) + '</td>' +
          '<td class="numeric">' + fmt(r.replies) + '</td>' +
          '<td class="numeric"><span class="badge ' + badgeClass(rr, replyRates) + '">' + pct(r.replies, r.leads) + '</span></td>' +
          '<td class="numeric">' + fmt(r.positives) + '</td>' +
          '<td class="numeric"><span class="badge ' + badgeClass(pr, posRates) + '">' + pct(r.positives, r.leads) + '</span></td>' +
          '<td class="numeric">' + fmt(r.booked) + '</td>' +
          '<td class="numeric"><span class="badge ' + badgeClass(br, bookRates) + '">' + pct(r.booked, r.leads) + '</span></td>' +
          '</tr>';
      });

      document.getElementById(containerId).innerHTML =
        '<div class="charts-row">' +
          '<div class="chart-container"><div class="chart-title">' + (posLabel || "Positive Rate") + '</div><div class="bar-chart">' + posChart + '</div></div>' +
          '<div class="chart-container"><div class="chart-title">' + (bookedLabel || "Booked Rate") + '</div><div class="bar-chart">' + bookChart + '</div></div>' +
        '</div>' +
        '<div class="table-wrap"><div class="table-scroll">' +
          '<table class="sortable"><thead><tr>' +
            '<th data-sort="string">' + (labelHeader || "Name") + ' <span class="sort-icon">▼</span></th>' +
            '<th class="numeric" data-sort="number">Leads <span class="sort-icon">▼</span></th>' +
            '<th class="numeric" data-sort="number">Replies <span class="sort-icon">▼</span></th>' +
            '<th class="numeric" data-sort="percent">Reply % <span class="sort-icon">▼</span></th>' +
            '<th class="numeric" data-sort="number">Positives <span class="sort-icon">▼</span></th>' +
            '<th class="numeric" data-sort="percent">Pos % <span class="sort-icon">▼</span></th>' +
            '<th class="numeric" data-sort="number">Booked <span class="sort-icon">▼</span></th>' +
            '<th class="numeric" data-sort="percent">Book % <span class="sort-icon">▼</span></th>' +
          '</tr></thead>' +
          '<tbody>' + tbody + '</tbody>' +
          '<tfoot><tr><td>Total</td>' +
            '<td class="numeric">' + fmt(totals.leads) + '</td>' +
            '<td class="numeric">' + fmt(totals.replies) + '</td>' +
            '<td class="numeric">' + pct(totals.replies, totals.leads) + '</td>' +
            '<td class="numeric">' + fmt(totals.positives) + '</td>' +
            '<td class="numeric">' + pct(totals.positives, totals.leads) + '</td>' +
            '<td class="numeric">' + fmt(totals.booked) + '</td>' +
            '<td class="numeric">' + pct(totals.booked, totals.leads) + '</td>' +
          '</tr></tfoot>' +
          '</table></div></div>';
    }

    // ── RENDER: RECOMMENDATIONS ──────────────────────────────────────────
    function renderRecommendations(recs) {
      if (!recs || Object.keys(recs).length === 0) {
        document.getElementById("recommendations-content").innerHTML =
          '<div class="chart-container" style="text-align:center;padding:40px 24px">' +
          '<div style="color:rgba(255,255,255,.3);font-size:13px;font-weight:500;text-transform:uppercase;letter-spacing:1px">Data coming soon</div>' +
          '</div>';
        return;
      }
      let html = '<div class="recommendations-grid">';
      Object.keys(recs).forEach(ct => {
        html += '<div class="recommendation-card"><h3><span class="type-icon"></span>' + ct + '</h3>';
        recs[ct].forEach((r, i) => {
          const posRate = pct(r.positives, r.leads);
          const bookRate = pct(r.booked, r.leads);
          html += '<div class="strategy-rank">' +
            '<div class="rank-number rank-' + (i + 1) + '">' + (i + 1) + '</div>' +
            '<div class="strategy-name">' + r.strategy + '</div>' +
            '<div class="strategy-metrics">' +
              '<div class="strategy-metric"><div class="strategy-metric-value">' + posRate + '</div><div class="strategy-metric-label">Pos Rate</div></div>' +
              '<div class="strategy-metric"><div class="strategy-metric-value">' + bookRate + '</div><div class="strategy-metric-label">Book Rate</div></div>' +
            '</div></div>';
        });
        html += '</div>';
      });
      html += '</div>';
      document.getElementById("recommendations-content").innerHTML = html;
    }

    // ── SORTABLE TABLES ──────────────────────────────────────────────────
    function initSortableTables() {
      document.querySelectorAll("table.sortable").forEach(table => {
        const ths = table.querySelectorAll("th");
        const tbody = table.querySelector("tbody");
        ths.forEach((th, i) => {
          th.addEventListener("click", () => {
            const type = th.dataset.sort;
            if (!type) return;
            const asc = th.classList.contains("sort-asc");
            ths.forEach(h => { h.classList.remove("sort-asc", "sort-desc"); h.querySelector(".sort-icon").textContent = "▼"; });
            th.classList.add(asc ? "sort-desc" : "sort-asc");
            th.querySelector(".sort-icon").textContent = asc ? "▼" : "▲";
            const rows = Array.from(tbody.querySelectorAll("tr"));
            rows.sort((a, b) => {
              let av = a.cells[i].textContent.trim(), bv = b.cells[i].textContent.trim();
              if (type === "number") { av = parseFloat(av.replace(/,/g, "")) || 0; bv = parseFloat(bv.replace(/,/g, "")) || 0; }
              else if (type === "percent") { av = parseFloat(av.replace("%", "")) || 0; bv = parseFloat(bv.replace("%", "")) || 0; }
              if (av < bv) return asc ? 1 : -1;
              if (av > bv) return asc ? -1 : 1;
              return 0;
            });
            rows.forEach(r => tbody.appendChild(r));
          });
        });
      });
    }

    // ── SCROLL SPY ───────────────────────────────────────────────────────
    function updateNav() {
      const sp = window.scrollY + 100;
      const sections = document.querySelectorAll("section[id]");
      const navLinks = document.querySelectorAll(".nav-link");
      sections.forEach(s => {
        if (sp >= s.offsetTop && sp < s.offsetTop + s.offsetHeight) {
          navLinks.forEach(l => {
            l.classList.toggle("active", l.getAttribute("href") === "#" + s.id);
          });
        }
      });
    }
    window.addEventListener("scroll", updateNav);

    // ── RENDER ALL ───────────────────────────────────────────────────────
    function renderAll() {
      const data = getCurrentData();
      if (!data) return;

      // Header
      document.getElementById("report-label").textContent = data.label + " Campaign Insights";
      document.getElementById("date-range").textContent = data.dateRange;
      document.title = data.label + " Campaign Insights - Branding By Books";

      // Sections
      renderOverview(data);
      renderSegment("company-size-content", data.companySize, "Size", "Positive Rate by Company Size", "Booked Rate by Company Size");
      renderSegment("company-type-content", data.companyType, "Company Type", "Positive Rate by Company Type", "Booked Rate by Company Type");
      renderSegment("strategy-content", data.strategy, "Strategy", "Positive Rate by Strategy", "Booked Rate by Strategy");
      renderRecommendations(data.recommendations);

      // Re-init table sorting
      initSortableTables();
      updateNav();
    }

    // ── MONTH SWITCHING ──────────────────────────────────────────────────
    function switchMonth(monthKey) {
      currentMonth = monthKey;
      document.querySelectorAll(".month-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.month === monthKey);
      });
      renderAll();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ── INIT ─────────────────────────────────────────────────────────────
    fetch("data.json")
      .then(r => { if (!r.ok) throw new Error("Failed to load data.json"); return r.json(); })
      .then(json => {
        DATA = json;
        // Default to latest month
        const keys = Object.keys(DATA.months).sort();
        currentMonth = keys[keys.length - 1] || "lifetime";
        // Show last updated
        if (DATA.lastUpdated) {
          const d = new Date(DATA.lastUpdated);
          const opts = { year: "numeric", month: "short", day: "numeric" };
          document.getElementById("last-updated").textContent = " \u00B7 Last updated: " + d.toLocaleDateString("en-GB", opts);
        }
        renderMonthSelector();
        renderAll();
      })
      .catch(err => {
        document.querySelector(".container").innerHTML =
          '<div style="text-align:center;padding:80px 20px;color:rgba(255,255,255,.5)">' +
          '<h2 style="margin-bottom:12px;color:rgba(255,255,255,.7)">Unable to load dashboard data</h2>' +
          '<p>' + err.message + '</p></div>';
      });
  </script>
</body>
</html>
